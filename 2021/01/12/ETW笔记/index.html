<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="ETW概述Event Tracing for Windows (ETW)是一种高效率的内核级跟踪工具，可以将内核或者应用程序定义的事件记录到日志文件中。使用者可以实时处理事件，也可以从日志文件中处理。 ETW可以动态地启用或禁用事件跟踪，无需重启计算机或应用程序。">
<meta property="og:type" content="article">
<meta property="og:title" content="ETW笔记">
<meta property="og:url" content="http://sup817ch.github.io/2021/01/12/ETW笔记/index.html">
<meta property="og:site_name" content="sup817ch&#39;s blog">
<meta property="og:description" content="ETW概述Event Tracing for Windows (ETW)是一种高效率的内核级跟踪工具，可以将内核或者应用程序定义的事件记录到日志文件中。使用者可以实时处理事件，也可以从日志文件中处理。 ETW可以动态地启用或禁用事件跟踪，无需重启计算机或应用程序。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://docs.microsoft.com/en-us/windows/win32/etw/images/etdiag2.png">
<meta property="og:updated_time" content="2021-01-15T09:56:06.277Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ETW笔记">
<meta name="twitter:description" content="ETW概述Event Tracing for Windows (ETW)是一种高效率的内核级跟踪工具，可以将内核或者应用程序定义的事件记录到日志文件中。使用者可以实时处理事件，也可以从日志文件中处理。 ETW可以动态地启用或禁用事件跟踪，无需重启计算机或应用程序。">
<meta name="twitter:image" content="https://docs.microsoft.com/en-us/windows/win32/etw/images/etdiag2.png">






  <link rel="canonical" href="http://sup817ch.github.io/2021/01/12/ETW笔记/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ETW笔记 | sup817ch's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">sup817ch's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://sup817ch.github.io/2021/01/12/ETW笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sup817ch">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sup817ch's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">ETW笔记
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-01-12 14:28:19" itemprop="dateCreated datePublished" datetime="2021-01-12T14:28:19+08:00">2021-01-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-01-15 17:56:06" itemprop="dateModified" datetime="2021-01-15T17:56:06+08:00">2021-01-15</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="ETW概述"><a href="#ETW概述" class="headerlink" title="ETW概述"></a>ETW概述</h1><p>Event Tracing for Windows (ETW)是一种高效率的内核级跟踪工具，可以将内核或者应用程序定义的事件记录到日志文件中。使用者可以实时处理事件，也可以从日志文件中处理。</p>
<p>ETW可以动态地启用或禁用事件跟踪，无需重启计算机或应用程序。</p>
<a id="more"></a>
<p>Event Tracing API分为三个组件：</p>
<ul>
<li>Controllers，用于启动或停止事件跟踪会话（Event tracing session）和启用提供程序(providers)</li>
<li>Providers，提供事件</li>
<li>Consumers，消费事件</li>
</ul>
<p>下图为事件跟踪模型</p>
<p><img src="https://docs.microsoft.com/en-us/windows/win32/etw/images/etdiag2.png" alt=""></p>
<h2 id="Controllers"><a href="#Controllers" class="headerlink" title="Controllers"></a>Controllers</h2><p>Controllers用于定义日志文件的大小和位置，启动和停止事件跟踪会话以及启用提供程序，以便提供程序能将事件记录到会话，管理缓冲池的大小以及获取会话的执行统计信息。会话的统计信息包括缓冲区的使用数量，投递数量以及事件和缓冲区的丢失数量。</p>
<h2 id="Providers"><a href="#Providers" class="headerlink" title="Providers"></a>Providers</h2><p>Providers具有提供事件的能力。在provider注册之后，controller就可以启用或禁用provider的事件跟踪。provider定义其对启用或禁用的解释。通常，一个启用的provider将生成事件，而禁用的provider则不会。这让使用者可以添加事件跟踪到应用程序中而无需一直生成事件。</p>
<p>尽管ETW模型将controller和provider分成了两个程序，但一个程序可以同时包含这两个组件</p>
<p>Providers有以下几种类型：</p>
<p><strong>MOF (classic) providers:</strong></p>
<ul>
<li>Use the <a href="https://docs.microsoft.com/en-us/windows/win32/api/evntrace/nf-evntrace-registertraceguidsa" target="_blank" rel="noopener">RegisterTraceGuids</a> and <a href="https://docs.microsoft.com/en-us/windows/win32/api/evntrace/nf-evntrace-traceevent" target="_blank" rel="noopener">TraceEvent</a> functions to register and write events.</li>
<li>Use MOF classes to define events so that consumers know how to consume them.</li>
<li>Can be enabled by only one trace session at a time.</li>
</ul>
<p><strong>WPP providers:</strong></p>
<ul>
<li>Use the <a href="https://docs.microsoft.com/en-us/windows/win32/api/evntrace/nf-evntrace-registertraceguidsa" target="_blank" rel="noopener">RegisterTraceGuids</a> and <a href="https://docs.microsoft.com/en-us/windows/win32/api/evntrace/nf-evntrace-traceevent" target="_blank" rel="noopener">TraceEvent</a> functions to register and write events.</li>
<li>Have associated TMF files (compiled into a binary’s .pdb) containing decoding information inferred from the preprocessor’s scan of WPP instrumentation in source code.</li>
<li>Can be enabled by only one trace session at a time.</li>
</ul>
<p><strong>Manifest-based providers:</strong></p>
<ul>
<li>Use <a href="https://docs.microsoft.com/en-us/windows/desktop/api/Evntprov/nf-evntprov-eventregister" target="_blank" rel="noopener">EventRegister</a> and <a href="https://docs.microsoft.com/en-us/windows/desktop/api/Evntprov/nf-evntprov-eventwrite" target="_blank" rel="noopener">EventWrite</a> to register and write events.</li>
<li>Use a manifest to define events so that consumers know how to consume them.</li>
<li>Can be enabled by up to eight trace sessions simultaneously.</li>
</ul>
<p><strong><a href="https://docs.microsoft.com/en-us/windows/desktop/tracelogging/trace-logging-about" target="_blank" rel="noopener">TraceLogging</a> providers:</strong></p>
<ul>
<li>Use <a href="https://docs.microsoft.com/en-us/windows/desktop/api/traceloggingprovider/nf-traceloggingprovider-traceloggingregister" target="_blank" rel="noopener">TraceLoggingRegister</a> and <a href="https://docs.microsoft.com/en-us/windows/desktop/api/traceloggingprovider/nf-traceloggingprovider-traceloggingwrite" target="_blank" rel="noopener">TraceLoggingWrite</a> to register and write events.</li>
<li>Use self-describing events so that the events themselves contain all required information for consuming them.</li>
<li>Can be enabled by up to eight trace sessions simultaneously.</li>
</ul>
<p>所有的providers都基于事件跟踪系列API (<a href="https://docs.microsoft.com/en-us/windows/win32/api/evntrace/nf-evntrace-traceevent" target="_blank" rel="noopener">TraceEvent</a> for legacy technologies and <a href="https://docs.microsoft.com/en-us/windows/desktop/api/Evntprov/nf-evntprov-eventwrite" target="_blank" rel="noopener">EventWrite</a>/<a href="https://docs.microsoft.com/en-us/windows/desktop/api/Evntprov/nf-evntprov-eventwriteex" target="_blank" rel="noopener">EventWriteEx</a> for newer ones).</p>
<h2 id="Consumers"><a href="#Consumers" class="headerlink" title="Consumers"></a>Consumers</h2><p>Consumers可以选择一个或多个事件跟踪会话作为事件的源。consumer可以同时从多个事件跟踪会话中请求事件；系统按事件顺序投递事件。consumer可以从日志文件中接收事件，也可以从会话中实时接收事件。当处理事件时，consumer可以指定开始和结束时间，只有在指定时间内的事件才会被投递。</p>
<h1 id="logman使用"><a href="#logman使用" class="headerlink" title="logman使用"></a>logman使用</h1><h2 id="列出所有正在运行的跟踪会话"><a href="#列出所有正在运行的跟踪会话" class="headerlink" title="列出所有正在运行的跟踪会话"></a>列出所有正在运行的跟踪会话</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt; logman query -ets</span><br><span class="line">Data Collector Set                Type    Status</span><br><span class="line">-------------------------------------------------</span><br><span class="line">Circular Kernel Context Logger    Trace   Running</span><br><span class="line">AppModel                          Trace   Running</span><br><span class="line">ScreenOnPowerStudyTraceSession    Trace   Running</span><br><span class="line">DiagLog                           Trace   Running</span><br><span class="line">EventLog-Application              Trace   Running</span><br><span class="line">EventLog-System                   Trace   Running</span><br><span class="line">LwtNetLog                         Trace   Running</span><br><span class="line">NtfsLog                           Trace   Running</span><br><span class="line">TileStore                         Trace   Running</span><br><span class="line">UBPM                              Trace   Running</span><br><span class="line">WdiContextLog                     Trace   Running</span><br><span class="line">WiFiSession                       Trace   Running</span><br><span class="line">UserNotPresentTraceSession        Trace   Running</span><br><span class="line">Diagtrack-Listener                Trace   Running</span><br><span class="line">MSDTC_TRACE_SESSION               Trace   Running</span><br><span class="line">WindowsUpdate_trace_log           Trace   Running</span><br></pre></td></tr></table></figure>
<h2 id="列出所有订阅跟踪会话的提供者"><a href="#列出所有订阅跟踪会话的提供者" class="headerlink" title="列出所有订阅跟踪会话的提供者"></a>列出所有订阅跟踪会话的提供者</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&gt; logman query &quot;EventLog-Application&quot; -ets</span><br><span class="line">Name:                 EventLog-Application</span><br><span class="line">Status:               Running</span><br><span class="line">Root Path:            %systemdrive%PerfLogsAdmin</span><br><span class="line">Segment:              Off</span><br><span class="line">Schedules:            On</span><br><span class="line">Segment Max Size:     100 MB</span><br><span class="line"></span><br><span class="line">Name:                 EventLog-ApplicationEventLog-Application</span><br><span class="line">Type:                 Trace</span><br><span class="line">Append:               Off</span><br><span class="line">Circular:             Off</span><br><span class="line">Overwrite:            Off</span><br><span class="line">Buffer Size:          64</span><br><span class="line">Buffers Lost:         0</span><br><span class="line">Buffers Written:      242</span><br><span class="line">Buffer Flush Timer:   1</span><br><span class="line">Clock Type:           System</span><br><span class="line">File Mode:            Real-time</span><br><span class="line"></span><br><span class="line">Provider:</span><br><span class="line">Name:                 Microsoft-Windows-SenseIR</span><br><span class="line">Provider Guid:        &#123;B6D775EF-1436-4FE6-BAD3-9E436319E218&#125;</span><br><span class="line">Level:                255</span><br><span class="line">KeywordsAll:          0x0</span><br><span class="line">KeywordsAny:          0x8000000000000000 (Microsoft-Windows-SenseIR/Operational)</span><br><span class="line">Properties:           65</span><br><span class="line">Filter Type:          0</span><br><span class="line"></span><br><span class="line">Provider:</span><br><span class="line">Name:                 Microsoft-Windows-WDAG-Service</span><br><span class="line">Provider Guid:        &#123;728B02D9-BF21-49F6-BE3F-91BC06F7467E&#125;</span><br><span class="line">Level:                255</span><br><span class="line">KeywordsAll:          0x0</span><br><span class="line">KeywordsAny:          0x8000000000000000</span><br><span class="line">Properties:           65</span><br><span class="line">Filter Type:          0</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Provider:</span><br><span class="line">Name:                 Microsoft-Windows-PowerShell</span><br><span class="line">Provider Guid:        &#123;A0C1853B-5C40-4B15-8766-3CF1C58F985A&#125;</span><br><span class="line">Level:                255</span><br><span class="line">KeywordsAll:          0x0</span><br><span class="line">KeywordsAny:          0x9000000000000000 (Microsoft-Windows-PowerShell/Operational,Microsoft-Windows-PowerShell/Admin)</span><br><span class="line">Properties:           65</span><br><span class="line">Filter Type:          0</span><br></pre></td></tr></table></figure>
<h2 id="列出所有已注册的ETW提供者"><a href="#列出所有已注册的ETW提供者" class="headerlink" title="列出所有已注册的ETW提供者"></a>列出所有已注册的ETW提供者</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; logman query providers</span><br></pre></td></tr></table></figure>
<h2 id="单独查看提供者"><a href="#单独查看提供者" class="headerlink" title="单独查看提供者"></a>单独查看提供者</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&gt; logman query providers Microsoft-Windows-PowerShell</span><br><span class="line">Provider                        GUID</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">Microsoft-Windows-PowerShell    &#123;A0C1853B-5C40-4B15-8766-3CF1C58F985A&#125;</span><br><span class="line"></span><br><span class="line">Value               Keyword              Description</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">0x0000000000000001  Runspace             PowerShell Runspace</span><br><span class="line">0x0000000000000002  Pipeline             Pipeline of Commands</span><br><span class="line">0x0000000000000004  Protocol             PowerShell remoting protocol</span><br><span class="line">0x0000000000000008  Transport            PowerShell remoting transport</span><br><span class="line">0x0000000000000010  Host                 PowerShell remoting host proxy calls</span><br><span class="line">0x0000000000000020  Cmdlets              All remoting cmdlets</span><br><span class="line">0x0000000000000040  Serializer           The serialization layer</span><br><span class="line">0x0000000000000080  Session              All session layer</span><br><span class="line">0x0000000000000100  Plugin               The managed PowerShell plugin worker</span><br><span class="line">0x0000000000000200  PSWorkflow           PSWorkflow Hosting And Execution Layer</span><br><span class="line">0x0001000000000000  win:ResponseTime     Response Time</span><br><span class="line">0x8000000000000000  Microsoft-Windows-PowerShell/Operational Microsoft-Windows-PowerShell/Operational</span><br><span class="line">0x4000000000000000  Microsoft-Windows-PowerShell/Analytic Microsoft-Windows-PowerShell/Analytic</span><br><span class="line">0x2000000000000000  Microsoft-Windows-PowerShell/Debug Microsoft-Windows-PowerShell/Debug</span><br><span class="line">0x1000000000000000  Microsoft-Windows-PowerShell/Admin Microsoft-Windows-PowerShell/Admin</span><br><span class="line"></span><br><span class="line">Value        Level                Description</span><br><span class="line">--------------------------------------------------------------------</span><br><span class="line">0x02         win:Error            Error</span><br><span class="line">0x03         win:Warning          Warning</span><br><span class="line">0x04         win:Informational    Information</span><br><span class="line">0x05         win:Verbose          Verbose</span><br><span class="line">0x14         Debug                Debug level defined by PowerShell (which is above Informational defined by system)</span><br><span class="line"></span><br><span class="line">PID          Image</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">0x00000730   C:WindowsSystem32WindowsPowerShellv1.0powershell.exe</span><br><span class="line">0x0000100c   C:WindowsSystem32WindowsPowerShellv1.0powershell.exe</span><br></pre></td></tr></table></figure>
<h2 id="查看进程接收的提供者"><a href="#查看进程接收的提供者" class="headerlink" title="查看进程接收的提供者"></a>查看进程接收的提供者</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&gt; logman query providers -pid 5244</span><br><span class="line">Provider                                 GUID</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">FWPUCLNT Trace Provider                  &#123;5A1600D2-68E5-4DE7-BCF4-1C2D215FE0FE&#125;</span><br><span class="line">Microsoft-Antimalware-Protection         &#123;E4B70372-261F-4C54-8FA6-A5A7914D73DA&#125;</span><br><span class="line">Microsoft-Antimalware-RTP                &#123;8E92DEEF-5E17-413B-B927-59B2F06A3CFC&#125;</span><br><span class="line">Microsoft-Antimalware-Service            &#123;751EF305-6C6E-4FED-B847-02EF79D26AEF&#125;</span><br><span class="line">Microsoft-IEFRAME                        &#123;5C8BB950-959E-4309-8908-67961A1205D5&#125;</span><br><span class="line">Microsoft-Windows-AppXDeployment         &#123;8127F6D4-59F9-4ABF-8952-3E3A02073D5F&#125;</span><br><span class="line">Microsoft-Windows-ASN1                   &#123;D92EF8AC-99DD-4AB8-B91D-C6EBA85F3755&#125;</span><br><span class="line">Microsoft-Windows-AsynchronousCausality  &#123;19A4C69A-28EB-4D4B-8D94-5F19055A1B5C&#125;</span><br><span class="line">Microsoft-Windows-CAPI2                  &#123;5BBCA4A8-B209-48DC-A8C7-B23D3E5216FB&#125;</span><br><span class="line">Microsoft-Windows-COM-Perf               &#123;B8D6861B-D20F-4EEC-BBAE-87E0DD80602B&#125;</span><br><span class="line">Microsoft-Windows-COM-RundownInstrumentation &#123;2957313D-FCAA-5D4A-2F69-32CE5F0AC44E&#125;</span><br><span class="line">Microsoft-Windows-COMRuntime             &#123;BF406804-6AFA-46E7-8A48-6C357E1D6D61&#125;</span><br><span class="line">Microsoft-Windows-Crypto-BCrypt          &#123;C7E089AC-BA2A-11E0-9AF7-68384824019B&#125;</span><br><span class="line">Microsoft-Windows-Crypto-NCrypt          &#123;E8ED09DC-100C-45E2-9FC8-B53399EC1F70&#125;</span><br><span class="line">Microsoft-Windows-Crypto-RSAEnh          &#123;152FDB2B-6E9D-4B60-B317-815D5F174C4A&#125;</span><br><span class="line">Microsoft-Windows-Deplorch               &#123;B9DA9FE6-AE5F-4F3E-B2FA-8E623C11DC75&#125;</span><br><span class="line">Microsoft-Windows-DNS-Client             &#123;1C95126E-7EEA-49A9-A3FE-A378B03DDB4D&#125;</span><br><span class="line">Microsoft-Windows-Heap-Snapshot          &#123;901D2AFA-4FF6-46D7-8D0E-53645E1A47F5&#125;</span><br><span class="line">Microsoft-Windows-Immersive-Shell-API    &#123;5F0E257F-C224-43E5-9555-2ADCB8540A58&#125;</span><br><span class="line">Microsoft-Windows-Kernel-AppCompat       &#123;16A1ADC1-9B7F-4CD9-94B3-D8296AB1B130&#125;</span><br><span class="line">Microsoft-Windows-KnownFolders           &#123;8939299F-2315-4C5C-9B91-ABB86AA0627D&#125;</span><br><span class="line">Microsoft-Windows-MPS-CLNT               &#123;37945DC2-899B-44D1-B79C-DD4A9E57FF98&#125;</span><br><span class="line">Microsoft-Windows-Networking-Correlation &#123;83ED54F0-4D48-4E45-B16E-726FFD1FA4AF&#125;</span><br><span class="line">Microsoft-Windows-NetworkProfile         &#123;FBCFAC3F-8459-419F-8E48-1F0B49CDB85E&#125;</span><br><span class="line">Microsoft-Windows-RPC                    &#123;6AD52B32-D609-4BE9-AE07-CE8DAE937E39&#125;</span><br><span class="line">Microsoft-Windows-RPC-Events             &#123;F4AED7C7-A898-4627-B053-44A7CAA12FCD&#125;</span><br><span class="line">Microsoft-Windows-Schannel-Events        &#123;91CC1150-71AA-47E2-AE18-C96E61736B6F&#125;</span><br><span class="line">Microsoft-Windows-Shell-Core             &#123;30336ED4-E327-447C-9DE0-51B652C86108&#125;</span><br><span class="line">Microsoft-Windows-URLMon                 &#123;245F975D-909D-49ED-B8F9-9A75691D6B6B&#125;</span><br><span class="line">Microsoft-Windows-User Profiles General  &#123;DB00DFB6-29F9-4A9C-9B3B-1F4F9E7D9770&#125;</span><br><span class="line">Microsoft-Windows-User-Diagnostic        &#123;305FC87B-002A-5E26-D297-60223012CA9C&#125;</span><br><span class="line">Microsoft-Windows-WebIO                  &#123;50B3E73C-9370-461D-BB9F-26F32D68887D&#125;</span><br><span class="line">Microsoft-Windows-Windows Defender       &#123;11CD958A-C507-4EF3-B3F2-5FD9DFBD2C78&#125;</span><br><span class="line">Microsoft-Windows-WinHttp                &#123;7D44233D-3055-4B9C-BA64-0D47CA40A232&#125;</span><br><span class="line">Microsoft-Windows-WinRT-Error            &#123;A86F8471-C31D-4FBC-A035-665D06047B03&#125;</span><br><span class="line">Microsoft-Windows-Winsock-NameResolution &#123;55404E71-4DB9-4DEB-A5F5-8F86E46DDE56&#125;</span><br><span class="line">Network Profile Manager                  &#123;D9131565-E1DD-4C9E-A728-951999C2ADB5&#125;</span><br><span class="line">Security: SChannel                       &#123;37D2C3CD-C5D4-4587-8531-4696C44244C8&#125;</span><br><span class="line">Windows Defender Firewall API            &#123;28C9F48F-D244-45A8-842F-DC9FBC9B6E92&#125;</span><br><span class="line">WMI_Tracing                              &#123;1FF6B227-2CA7-40F9-9A66-980EADAA602E&#125;</span><br><span class="line">WMI_Tracing_Client_Operations            &#123;8E6B6962-AB54-4335-8229-3255B919DD0E&#125;</span><br><span class="line">&#123;05F95EFE-7F75-49C7-A994-60A55CC09571&#125;   &#123;05F95EFE-7F75-49C7-A994-60A55CC09571&#125;</span><br><span class="line">&#123;072665FB-8953-5A85-931D-D06AEAB3D109&#125;   &#123;072665FB-8953-5A85-931D-D06AEAB3D109&#125;</span><br><span class="line">&#123;7AF898D7-7E0E-518D-5F96-B1E79239484C&#125;   &#123;7AF898D7-7E0E-518D-5F96-B1E79239484C&#125;</span><br><span class="line">... output truncated ...</span><br></pre></td></tr></table></figure>
<h1 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h1><h2 id="NT-Kernel-Logger的开启与事件获取（TdhFormatProperty）"><a href="#NT-Kernel-Logger的开启与事件获取（TdhFormatProperty）" class="headerlink" title="NT Kernel Logger的开启与事件获取（TdhFormatProperty）"></a>NT Kernel Logger的开启与事件获取（TdhFormatProperty）</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INITGUID  <span class="comment">// Include this #define to use SystemTraceControlGuid in Evntrace.h.</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;conio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;strsafe.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;wmistr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;evntrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;evntcons.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tdh.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;in6addr.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">"tdh.lib"</span>)</span></span><br><span class="line"></span><br><span class="line">TRACEHANDLE g_SessionHandle = <span class="number">0</span>;</span><br><span class="line">EVENT_TRACE_PROPERTIES* g_pSessionProperties = <span class="literal">NULL</span>;</span><br><span class="line">EVENT_TRACE_LOGFILE g_TraceLogFile = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">TRACEHANDLE g_TraceHandle = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> WINAPI <span class="title">ProcessEvent</span><span class="params">(PEVENT_RECORD pEvent)</span></span>;</span><br><span class="line"><span class="function">DWORD <span class="title">GetEventInformation</span><span class="params">(PEVENT_RECORD pEvent, PTRACE_EVENT_INFO &amp; pInfo)</span></span>;</span><br><span class="line"><span class="function">PBYTE <span class="title">PrintProperties</span><span class="params">(PEVENT_RECORD pEvent, PTRACE_EVENT_INFO pInfo, DWORD PointerSize, USHORT i, PBYTE pUserData, PBYTE pEndOfUserData)</span></span>;</span><br><span class="line"><span class="function">DWORD <span class="title">GetPropertyLength</span><span class="params">(PEVENT_RECORD pEvent, PTRACE_EVENT_INFO pInfo, USHORT i, PUSHORT PropertyLength)</span></span>;</span><br><span class="line"><span class="function">DWORD <span class="title">GetArraySize</span><span class="params">(PEVENT_RECORD pEvent, PTRACE_EVENT_INFO pInfo, USHORT i, PUSHORT ArraySize)</span></span>;</span><br><span class="line"><span class="function">DWORD <span class="title">GetMapInfo</span><span class="params">(PEVENT_RECORD pEvent, LPWSTR pMapName, DWORD DecodingSource, PEVENT_MAP_INFO &amp; pMapInfo)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RemoveTrailingSpace</span><span class="params">(PEVENT_MAP_INFO pMapInfo)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">PBYTE <span class="title">PrintProperties</span><span class="params">(PEVENT_RECORD pEvent, PTRACE_EVENT_INFO pInfo, DWORD PointerSize, USHORT i, PBYTE pUserData, PBYTE pEndOfUserData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TDHSTATUS status = ERROR_SUCCESS;</span><br><span class="line">    USHORT PropertyLength = <span class="number">0</span>;</span><br><span class="line">    DWORD FormattedDataSize = <span class="number">0</span>;</span><br><span class="line">    USHORT UserDataConsumed = <span class="number">0</span>;</span><br><span class="line">    USHORT UserDataLength = <span class="number">0</span>;</span><br><span class="line">    LPWSTR pFormattedData = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD LastMember = <span class="number">0</span>;  <span class="comment">// Last member of a structure</span></span><br><span class="line">    USHORT ArraySize = <span class="number">0</span>;</span><br><span class="line">    PEVENT_MAP_INFO pMapInfo = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the length of the property.</span></span><br><span class="line"></span><br><span class="line">    status = GetPropertyLength(pEvent, pInfo, i, &amp;PropertyLength);</span><br><span class="line">    <span class="keyword">if</span> (ERROR_SUCCESS != status)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[%s] GetPropertyLength failed with %lu\n"</span>, __FUNCTION__, status);</span><br><span class="line">        pUserData = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the size of the array if the property is an array.</span></span><br><span class="line"></span><br><span class="line">    status = GetArraySize(pEvent, pInfo, i, &amp;ArraySize);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (USHORT k = <span class="number">0</span>; k &lt; ArraySize; k++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// If the property is a structure, print the members of the structure.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((pInfo-&gt;EventPropertyInfoArray[i].Flags &amp; PropertyStruct) == PropertyStruct)</span><br><span class="line">        &#123;</span><br><span class="line">            LastMember = pInfo-&gt;EventPropertyInfoArray[i].structType.StructStartIndex +</span><br><span class="line">                pInfo-&gt;EventPropertyInfoArray[i].structType.NumOfStructMembers;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (USHORT j = pInfo-&gt;EventPropertyInfoArray[i].structType.StructStartIndex; j &lt; LastMember; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                pUserData = PrintProperties(pEvent, pInfo, PointerSize, j, pUserData, pEndOfUserData);</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">NULL</span> == pUserData)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"[%s] Printing the members of the structure failed.\n"</span>, __FUNCTION__);</span><br><span class="line">                    pUserData = <span class="literal">NULL</span>;</span><br><span class="line">                    <span class="keyword">goto</span> cleanup;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Get the name/value mapping if the property specifies a value map.</span></span><br><span class="line"></span><br><span class="line">            status = GetMapInfo(pEvent,</span><br><span class="line">                (PWCHAR)((PBYTE)(pInfo)+pInfo-&gt;EventPropertyInfoArray[i].nonStructType.MapNameOffset),</span><br><span class="line">                pInfo-&gt;DecodingSource,</span><br><span class="line">                pMapInfo);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ERROR_SUCCESS != status)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"GetMapInfo failed\n"</span>);</span><br><span class="line">                pUserData = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="keyword">goto</span> cleanup;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Get the size of the buffer required for the formatted data.</span></span><br><span class="line"></span><br><span class="line">            status = TdhFormatProperty(</span><br><span class="line">                pInfo,</span><br><span class="line">                pMapInfo,</span><br><span class="line">                PointerSize,</span><br><span class="line">                pInfo-&gt;EventPropertyInfoArray[i].nonStructType.InType,</span><br><span class="line">                pInfo-&gt;EventPropertyInfoArray[i].nonStructType.OutType,</span><br><span class="line">                PropertyLength,</span><br><span class="line">                (USHORT)(pEndOfUserData - pUserData),</span><br><span class="line">                pUserData,</span><br><span class="line">                &amp;FormattedDataSize,</span><br><span class="line">                pFormattedData,</span><br><span class="line">                &amp;UserDataConsumed);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ERROR_INSUFFICIENT_BUFFER == status)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (pFormattedData)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">free</span>(pFormattedData);</span><br><span class="line">                    pFormattedData = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                pFormattedData = (LPWSTR)<span class="built_in">malloc</span>(FormattedDataSize);</span><br><span class="line">                <span class="keyword">if</span> (pFormattedData == <span class="literal">NULL</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"[%s] Failed to allocate memory for formatted data (size=%lu).\n"</span>, __FUNCTION__, FormattedDataSize);</span><br><span class="line">                    status = ERROR_OUTOFMEMORY;</span><br><span class="line">                    pUserData = <span class="literal">NULL</span>;</span><br><span class="line">                    <span class="keyword">goto</span> cleanup;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Retrieve the formatted data.</span></span><br><span class="line"></span><br><span class="line">                status = TdhFormatProperty(</span><br><span class="line">                    pInfo,</span><br><span class="line">                    pMapInfo,</span><br><span class="line">                    PointerSize,</span><br><span class="line">                    pInfo-&gt;EventPropertyInfoArray[i].nonStructType.InType,</span><br><span class="line">                    pInfo-&gt;EventPropertyInfoArray[i].nonStructType.OutType,</span><br><span class="line">                    PropertyLength,</span><br><span class="line">                    (USHORT)(pEndOfUserData - pUserData),</span><br><span class="line">                    pUserData,</span><br><span class="line">                    &amp;FormattedDataSize,</span><br><span class="line">                    pFormattedData,</span><br><span class="line">                    &amp;UserDataConsumed);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ERROR_SUCCESS == status)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%ws: %ws\n"</span>,</span><br><span class="line">                    (PWCHAR)((PBYTE)(pInfo)+pInfo-&gt;EventPropertyInfoArray[i].NameOffset),</span><br><span class="line">                    pFormattedData);</span><br><span class="line"></span><br><span class="line">                pUserData += UserDataConsumed;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"[%s] TdhFormatProperty failed with %lu.\n"</span>, __FUNCTION__, status);</span><br><span class="line">                pUserData = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="keyword">goto</span> cleanup;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">cleanup:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pFormattedData)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">free</span>(pFormattedData);</span><br><span class="line">        pFormattedData = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pMapInfo)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">free</span>(pMapInfo);</span><br><span class="line">        pMapInfo = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pUserData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Get the length of the property data. For MOF-based events, the size is inferred from the data type</span></span><br><span class="line"><span class="comment">// of the property. For manifest-based events, the property can specify the size of the property value</span></span><br><span class="line"><span class="comment">// using the length attribute. The length attribue can specify the size directly or specify the name </span></span><br><span class="line"><span class="comment">// of another property in the event data that contains the size. If the property does not include the </span></span><br><span class="line"><span class="comment">// length attribute, the size is inferred from the data type. The length will be zero for variable</span></span><br><span class="line"><span class="comment">// length, null-terminated strings and structures.</span></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">GetPropertyLength</span><span class="params">(PEVENT_RECORD pEvent, PTRACE_EVENT_INFO pInfo, USHORT i, PUSHORT PropertyLength)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD status = ERROR_SUCCESS;</span><br><span class="line">    PROPERTY_DATA_DESCRIPTOR DataDescriptor;</span><br><span class="line">    DWORD PropertySize = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the property is a binary blob and is defined in a manifest, the property can </span></span><br><span class="line">    <span class="comment">// specify the blob's size or it can point to another property that defines the </span></span><br><span class="line">    <span class="comment">// blob's size. The PropertyParamLength flag tells you where the blob's size is defined.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((pInfo-&gt;EventPropertyInfoArray[i].Flags &amp; PropertyParamLength) == PropertyParamLength)</span><br><span class="line">    &#123;</span><br><span class="line">        DWORD Length = <span class="number">0</span>;  <span class="comment">// Expects the length to be defined by a UINT16 or UINT32</span></span><br><span class="line">        DWORD j = pInfo-&gt;EventPropertyInfoArray[i].lengthPropertyIndex;</span><br><span class="line">        ZeroMemory(&amp;DataDescriptor, <span class="keyword">sizeof</span>(PROPERTY_DATA_DESCRIPTOR));</span><br><span class="line">        DataDescriptor.PropertyName = (ULONGLONG)((PBYTE)(pInfo)+pInfo-&gt;EventPropertyInfoArray[j].NameOffset);</span><br><span class="line">        DataDescriptor.ArrayIndex = ULONG_MAX;</span><br><span class="line">        status = TdhGetPropertySize(pEvent, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">1</span>, &amp;DataDescriptor, &amp;PropertySize);</span><br><span class="line">        status = TdhGetProperty(pEvent, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">1</span>, &amp;DataDescriptor, PropertySize, (PBYTE)&amp;Length);</span><br><span class="line">        *PropertyLength = (USHORT)Length;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (pInfo-&gt;EventPropertyInfoArray[i].length &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            *PropertyLength = pInfo-&gt;EventPropertyInfoArray[i].length;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// If the property is a binary blob and is defined in a MOF class, the extension</span></span><br><span class="line">            <span class="comment">// qualifier is used to determine the size of the blob. However, if the extension </span></span><br><span class="line">            <span class="comment">// is IPAddrV6, you must set the PropertyLength variable yourself because the </span></span><br><span class="line">            <span class="comment">// EVENT_PROPERTY_INFO.length field will be zero.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (TDH_INTYPE_BINARY == pInfo-&gt;EventPropertyInfoArray[i].nonStructType.InType &amp;&amp;</span><br><span class="line">                TDH_OUTTYPE_IPV6 == pInfo-&gt;EventPropertyInfoArray[i].nonStructType.OutType)</span><br><span class="line">            &#123;</span><br><span class="line">                *PropertyLength = (USHORT)<span class="keyword">sizeof</span>(IN6_ADDR);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (TDH_INTYPE_UNICODESTRING == pInfo-&gt;EventPropertyInfoArray[i].nonStructType.InType ||</span><br><span class="line">                TDH_INTYPE_ANSISTRING == pInfo-&gt;EventPropertyInfoArray[i].nonStructType.InType ||</span><br><span class="line">                (pInfo-&gt;EventPropertyInfoArray[i].Flags &amp; PropertyStruct) == PropertyStruct)</span><br><span class="line">            &#123;</span><br><span class="line">                *PropertyLength = pInfo-&gt;EventPropertyInfoArray[i].length;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                *PropertyLength = pInfo-&gt;EventPropertyInfoArray[i].length;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"[%s] Unexpected length of 0 for intype %d and outtype %d\n"</span>,</span><br><span class="line">                    __FUNCTION__,</span><br><span class="line">                    pInfo-&gt;EventPropertyInfoArray[i].nonStructType.InType,</span><br><span class="line">                    pInfo-&gt;EventPropertyInfoArray[i].nonStructType.OutType);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//status = ERROR_EVT_INVALID_EVENT_DATA;</span></span><br><span class="line">                <span class="comment">//goto cleanup;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">cleanup:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Get the size of the array. For MOF-based events, the size is specified in the declaration or using </span></span><br><span class="line"><span class="comment">// the MAX qualifier. For manifest-based events, the property can specify the size of the array</span></span><br><span class="line"><span class="comment">// using the count attribute. The count attribue can specify the size directly or specify the name </span></span><br><span class="line"><span class="comment">// of another property in the event data that contains the size.</span></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">GetArraySize</span><span class="params">(PEVENT_RECORD pEvent, PTRACE_EVENT_INFO pInfo, USHORT i, PUSHORT ArraySize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD status = ERROR_SUCCESS;</span><br><span class="line">    PROPERTY_DATA_DESCRIPTOR DataDescriptor;</span><br><span class="line">    DWORD PropertySize = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((pInfo-&gt;EventPropertyInfoArray[i].Flags &amp; PropertyParamCount) == PropertyParamCount)</span><br><span class="line">    &#123;</span><br><span class="line">        DWORD Count = <span class="number">0</span>;  <span class="comment">// Expects the count to be defined by a UINT16 or UINT32</span></span><br><span class="line">        DWORD j = pInfo-&gt;EventPropertyInfoArray[i].countPropertyIndex;</span><br><span class="line">        ZeroMemory(&amp;DataDescriptor, <span class="keyword">sizeof</span>(PROPERTY_DATA_DESCRIPTOR));</span><br><span class="line">        DataDescriptor.PropertyName = (ULONGLONG)((PBYTE)(pInfo)+pInfo-&gt;EventPropertyInfoArray[j].NameOffset);</span><br><span class="line">        DataDescriptor.ArrayIndex = ULONG_MAX;</span><br><span class="line">        status = TdhGetPropertySize(pEvent, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">1</span>, &amp;DataDescriptor, &amp;PropertySize);</span><br><span class="line">        status = TdhGetProperty(pEvent, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">1</span>, &amp;DataDescriptor, PropertySize, (PBYTE)&amp;Count);</span><br><span class="line">        *ArraySize = (USHORT)Count;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        *ArraySize = pInfo-&gt;EventPropertyInfoArray[i].count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Both MOF-based events and manifest-based events can specify name/value maps. The</span></span><br><span class="line"><span class="comment">// map values can be integer values or bit values. If the property specifies a value</span></span><br><span class="line"><span class="comment">// map, get the map.</span></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">GetMapInfo</span><span class="params">(PEVENT_RECORD pEvent, LPWSTR pMapName, DWORD DecodingSource, PEVENT_MAP_INFO &amp; pMapInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD status = ERROR_SUCCESS;</span><br><span class="line">    DWORD MapSize = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Retrieve the required buffer size for the map info.</span></span><br><span class="line"></span><br><span class="line">    status = TdhGetEventMapInformation(pEvent, pMapName, pMapInfo, &amp;MapSize);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ERROR_INSUFFICIENT_BUFFER == status)</span><br><span class="line">    &#123;</span><br><span class="line">        pMapInfo = (PEVENT_MAP_INFO)<span class="built_in">malloc</span>(MapSize);</span><br><span class="line">        <span class="keyword">if</span> (pMapInfo == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Failed to allocate memory for map info (size=%lu).\n"</span>, MapSize);</span><br><span class="line">            status = ERROR_OUTOFMEMORY;</span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Retrieve the map info.</span></span><br><span class="line"></span><br><span class="line">        status = TdhGetEventMapInformation(pEvent, pMapName, pMapInfo, &amp;MapSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ERROR_SUCCESS == status)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (DecodingSourceXMLFile == DecodingSource)</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveTrailingSpace(pMapInfo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ERROR_NOT_FOUND == status)</span><br><span class="line">        &#123;</span><br><span class="line">            status = ERROR_SUCCESS; <span class="comment">// This case is okay.</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"TdhGetEventMapInformation failed with 0x%x.\n"</span>, status);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">cleanup:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// The mapped string values defined in a manifest will contain a trailing space</span></span><br><span class="line"><span class="comment">// in the EVENT_MAP_ENTRY structure. Replace the trailing space with a null-</span></span><br><span class="line"><span class="comment">// terminating character, so that the bit mapped strings are correctly formatted.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RemoveTrailingSpace</span><span class="params">(PEVENT_MAP_INFO pMapInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD ByteLength = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (DWORD i = <span class="number">0</span>; i &lt; pMapInfo-&gt;EntryCount; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ByteLength = (wcslen((LPWSTR)((PBYTE)pMapInfo + pMapInfo-&gt;MapEntryArray[i].OutputOffset)) - <span class="number">1</span>) * <span class="number">2</span>;</span><br><span class="line">        *((LPWSTR)((PBYTE)pMapInfo + (pMapInfo-&gt;MapEntryArray[i].OutputOffset + ByteLength))) = L'\<span class="number">0'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Get the metadata for the event.</span></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">GetEventInformation</span><span class="params">(PEVENT_RECORD pEvent, PTRACE_EVENT_INFO &amp; pInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD status = ERROR_SUCCESS;</span><br><span class="line">    DWORD BufferSize = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Retrieve the required buffer size for the event metadata.</span></span><br><span class="line"></span><br><span class="line">    status = TdhGetEventInformation(pEvent, <span class="number">0</span>, <span class="literal">NULL</span>, pInfo, &amp;BufferSize);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ERROR_INSUFFICIENT_BUFFER == status)</span><br><span class="line">    &#123;</span><br><span class="line">        pInfo = (TRACE_EVENT_INFO*)<span class="built_in">malloc</span>(BufferSize);</span><br><span class="line">        <span class="keyword">if</span> (pInfo == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Failed to allocate memory for event info (size=%lu).\n"</span>, BufferSize);</span><br><span class="line">            status = ERROR_OUTOFMEMORY;</span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Retrieve the event metadata.</span></span><br><span class="line"></span><br><span class="line">        status = TdhGetEventInformation(pEvent, <span class="number">0</span>, <span class="literal">NULL</span>, pInfo, &amp;BufferSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ERROR_SUCCESS != status)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"TdhGetEventInformation failed with 0x%x.\n"</span>, status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">cleanup:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">BufferCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    PEVENT_TRACE_LOGFILEA Logfile</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[%s] In BufferCallback\n"</span>, __FUNCTION__);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> WINAPI <span class="title">RecordCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    PEVENT_RECORD EventRecord</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD status = ERROR_SUCCESS;</span><br><span class="line">    PTRACE_EVENT_INFO pInfo = <span class="literal">NULL</span>;</span><br><span class="line">    LPWSTR pwsEventGuid = <span class="literal">NULL</span>;</span><br><span class="line">    PBYTE pUserData = <span class="literal">NULL</span>;</span><br><span class="line">    PBYTE pEndOfUserData = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD PointerSize = <span class="number">0</span>;</span><br><span class="line">    ULONGLONG TimeStamp = <span class="number">0</span>;</span><br><span class="line">    ULONGLONG Nanoseconds = <span class="number">0</span>;</span><br><span class="line">    SYSTEMTIME st;</span><br><span class="line">    SYSTEMTIME stLocal;</span><br><span class="line">    FILETIME ft;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Skips the event if it is the event trace header. Log files contain this event</span></span><br><span class="line">    <span class="comment">// but real-time sessions do not. The event contains the same information as </span></span><br><span class="line">    <span class="comment">// the EVENT_TRACE_LOGFILE.LogfileHeader member that you can access when you open </span></span><br><span class="line">    <span class="comment">// the trace. </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (IsEqualGUID(EventRecord-&gt;EventHeader.ProviderId, EventTraceGuid) &amp;&amp;</span><br><span class="line">        EventRecord-&gt;EventHeader.EventDescriptor.Opcode == EVENT_TRACE_TYPE_INFO)</span><br><span class="line">    &#123;</span><br><span class="line">        ; <span class="comment">// Skip this event.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Process the event. The pEvent-&gt;UserData member is a pointer to </span></span><br><span class="line">        <span class="comment">// the event specific data, if it exists.</span></span><br><span class="line"></span><br><span class="line">        status = GetEventInformation(EventRecord, pInfo);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ERROR_SUCCESS != status)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[%s] GetEventInformation failed with %lu\n"</span>, __FUNCTION__, status);</span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Determine whether the event is defined by a MOF class, in an</span></span><br><span class="line">        <span class="comment">// instrumentation manifest, or a WPP template; to use TDH to decode</span></span><br><span class="line">        <span class="comment">// the event, it must be defined by one of these three sources.</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\nProcess Id: %d\n"</span>, EventRecord-&gt;EventHeader.ProcessId);</span><br><span class="line">        <span class="keyword">if</span> (DecodingSourceWbem == pInfo-&gt;DecodingSource)  <span class="comment">// MOF class</span></span><br><span class="line">        &#123;</span><br><span class="line">            HRESULT hr = StringFromCLSID(pInfo-&gt;EventGuid, &amp;pwsEventGuid);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"StringFromCLSID failed with 0x%x\n"</span>, hr);</span><br><span class="line">                status = hr;</span><br><span class="line">                <span class="keyword">goto</span> cleanup;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Event GUID: %ws\n"</span>, pwsEventGuid);</span><br><span class="line">            CoTaskMemFree(pwsEventGuid);</span><br><span class="line">            pwsEventGuid = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Event version: %d\n"</span>, EventRecord-&gt;EventHeader.EventDescriptor.Version);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Event type: %d\n"</span>, EventRecord-&gt;EventHeader.EventDescriptor.Opcode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (DecodingSourceXMLFile == pInfo-&gt;DecodingSource) <span class="comment">// Instrumentation manifest</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Event ID: %d\n"</span>, pInfo-&gt;EventDescriptor.Id);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="comment">// Not handling the WPP case</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Not handling the WPP case\n"</span>);</span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Print the time stamp for when the event occurred.</span></span><br><span class="line"></span><br><span class="line">        ft.dwHighDateTime = EventRecord-&gt;EventHeader.TimeStamp.HighPart;</span><br><span class="line">        ft.dwLowDateTime = EventRecord-&gt;EventHeader.TimeStamp.LowPart;</span><br><span class="line"></span><br><span class="line">        FileTimeToSystemTime(&amp;ft, &amp;st);</span><br><span class="line">        SystemTimeToTzSpecificLocalTime(<span class="literal">NULL</span>, &amp;st, &amp;stLocal);</span><br><span class="line"></span><br><span class="line">        TimeStamp = EventRecord-&gt;EventHeader.TimeStamp.QuadPart;</span><br><span class="line">        Nanoseconds = (TimeStamp % <span class="number">10000000</span>) * <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%02d/%02d/%02d %02d:%02d:%02d.%I64u\n"</span>,</span><br><span class="line">            stLocal.wMonth, stLocal.wDay, stLocal.wYear, stLocal.wHour, stLocal.wMinute, stLocal.wSecond, Nanoseconds);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the event contains event-specific data use TDH to extract</span></span><br><span class="line">        <span class="comment">// the event data. For this example, to extract the data, the event </span></span><br><span class="line">        <span class="comment">// must be defined by a MOF class or an instrumentation manifest.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Need to get the PointerSize for each event to cover the case where you are</span></span><br><span class="line">        <span class="comment">// consuming events from multiple log files that could have been generated on </span></span><br><span class="line">        <span class="comment">// different architectures. Otherwise, you could have accessed the pointer</span></span><br><span class="line">        <span class="comment">// size when you opened the trace above (see pHeader-&gt;PointerSize).</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (EVENT_HEADER_FLAG_32_BIT_HEADER == (EventRecord-&gt;EventHeader.Flags &amp; EVENT_HEADER_FLAG_32_BIT_HEADER))</span><br><span class="line">        &#123;</span><br><span class="line">            PointerSize = <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            PointerSize = <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pUserData = (PBYTE)EventRecord-&gt;UserData;</span><br><span class="line">        pEndOfUserData = (PBYTE)EventRecord-&gt;UserData + EventRecord-&gt;UserDataLength;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Print the event data for all the top-level properties. Metadata for all the </span></span><br><span class="line">        <span class="comment">// top-level properties come before structure member properties in the </span></span><br><span class="line">        <span class="comment">// property information array.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (USHORT i = <span class="number">0</span>; i &lt; pInfo-&gt;TopLevelPropertyCount; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            pUserData = PrintProperties(EventRecord, pInfo, PointerSize, i, pUserData, pEndOfUserData);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">NULL</span> == pUserData)</span><br><span class="line">            &#123;</span><br><span class="line">                wprintf(<span class="string">L"Printing top level properties failed.\n"</span>);</span><br><span class="line">                <span class="keyword">goto</span> cleanup;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">cleanup:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pInfo)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">free</span>(pInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ERROR_SUCCESS != status || <span class="literal">NULL</span> == pUserData)</span><br><span class="line">    &#123;</span><br><span class="line">        CloseTrace(g_TraceHandle);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">MyInitTrace</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ULONG status = ERROR_SUCCESS;</span><br><span class="line">    ULONG BufferSize = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allocate memory for the session properties. The memory must</span></span><br><span class="line">    <span class="comment">// be large enough to include the log file name and session name,</span></span><br><span class="line">    <span class="comment">// which get appended to the end of the session properties structure.</span></span><br><span class="line"></span><br><span class="line">    BufferSize = <span class="keyword">sizeof</span>(EVENT_TRACE_PROPERTIES) + <span class="keyword">sizeof</span>(KERNEL_LOGGER_NAME);</span><br><span class="line">    g_pSessionProperties = (EVENT_TRACE_PROPERTIES*)<span class="built_in">malloc</span>(BufferSize);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == g_pSessionProperties)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[%s] Unable to allocate %d bytes for properties structure.\n"</span>, __FUNCTION__, BufferSize);</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the session properties. You only append the log file name</span></span><br><span class="line">    <span class="comment">// to the properties structure; the StartTrace function appends</span></span><br><span class="line">    <span class="comment">// the session name for you.</span></span><br><span class="line">starttrace:</span><br><span class="line">    ZeroMemory(g_pSessionProperties, BufferSize);</span><br><span class="line">    g_pSessionProperties-&gt;Wnode.BufferSize = BufferSize;</span><br><span class="line">    g_pSessionProperties-&gt;Wnode.Flags = WNODE_FLAG_TRACED_GUID;</span><br><span class="line">    g_pSessionProperties-&gt;Wnode.ClientContext = <span class="number">1</span>; <span class="comment">//QPC clock resolution</span></span><br><span class="line">    g_pSessionProperties-&gt;Wnode.Guid = SystemTraceControlGuid;</span><br><span class="line">    g_pSessionProperties-&gt;EnableFlags = EVENT_TRACE_FLAG_PROCESS;</span><br><span class="line">    g_pSessionProperties-&gt;LogFileMode = EVENT_TRACE_REAL_TIME_MODE;</span><br><span class="line">    g_pSessionProperties-&gt;FlushTimer = <span class="number">1</span>;</span><br><span class="line">    g_pSessionProperties-&gt;LoggerNameOffset = <span class="keyword">sizeof</span>(EVENT_TRACE_PROPERTIES);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the trace session.</span></span><br><span class="line"></span><br><span class="line">    status = StartTrace((PTRACEHANDLE)&amp;g_SessionHandle, KERNEL_LOGGER_NAME, g_pSessionProperties);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ERROR_SUCCESS != status)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ERROR_ALREADY_EXISTS == status)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[%s] The NT Kernel Logger session is already in use.\n"</span>, __FUNCTION__);</span><br><span class="line"></span><br><span class="line">            status = ControlTrace(<span class="literal">NULL</span>, KERNEL_LOGGER_NAME, g_pSessionProperties, EVENT_TRACE_CONTROL_UPDATE);</span><br><span class="line">            <span class="keyword">if</span> (ERROR_SUCCESS != status)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"[%s] ControlTrace(update) failed with %lu\n"</span>, __FUNCTION__, status);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[%s] StartTrace() failed with %lu\n"</span>, __FUNCTION__, status);</span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = EnableTraceEx2(g_SessionHandle, &amp;SystemTraceControlGuid, EVENT_CONTROL_CODE_ENABLE_PROVIDER, TRACE_LEVEL_VERBOSE, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ERROR_SUCCESS != status)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[%s] EnableTraceEx2() failed with %lu\n"</span>, __FUNCTION__, status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">opentrace:</span><br><span class="line">    g_TraceLogFile.LoggerName = KERNEL_LOGGER_NAME;</span><br><span class="line">    g_TraceLogFile.ProcessTraceMode = PROCESS_TRACE_MODE_EVENT_RECORD | PROCESS_TRACE_MODE_REAL_TIME;</span><br><span class="line">    g_TraceLogFile.BufferCallback = (PEVENT_TRACE_BUFFER_CALLBACK)BufferCallback;</span><br><span class="line">    g_TraceLogFile.EventRecordCallback = (PEVENT_RECORD_CALLBACK)RecordCallback;</span><br><span class="line"></span><br><span class="line">    g_TraceHandle = OpenTrace(&amp;g_TraceLogFile);</span><br><span class="line">    <span class="keyword">if</span> (INVALID_PROCESSTRACE_HANDLE == g_TraceHandle)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[%s] OpenTrace() failed with %lu\n"</span>, __FUNCTION__, GetLastError());</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cleanup:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (g_TraceHandle &amp;&amp; INVALID_PROCESSTRACE_HANDLE != g_TraceHandle)</span><br><span class="line">    &#123;</span><br><span class="line">        status = CloseTrace(g_TraceHandle);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ERROR_SUCCESS != status)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[%s] CloseTrace() failed with %lu\n"</span>, __FUNCTION__, status);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (g_SessionHandle)</span><br><span class="line">    &#123;</span><br><span class="line">        status = EnableTraceEx2(g_SessionHandle, &amp;SystemTraceControlGuid, EVENT_CONTROL_CODE_DISABLE_PROVIDER, TRACE_LEVEL_VERBOSE, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ERROR_SUCCESS != status)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[%s] EnableTraceEx2(disable) failed with %lu\n"</span>, __FUNCTION__, status);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        status = ControlTrace(g_SessionHandle, KERNEL_LOGGER_NAME, g_pSessionProperties, EVENT_TRACE_CONTROL_STOP);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ERROR_SUCCESS != status)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[%s] ControlTrace(stop) failed with %lu\n"</span>, __FUNCTION__, status);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (g_pSessionProperties)</span><br><span class="line">        <span class="built_in">free</span>(g_pSessionProperties);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">MyStratTrace</span><span class="params">(LPVOID lpParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ULONG status = ERROR_SUCCESS;</span><br><span class="line"></span><br><span class="line">    status = ProcessTrace(&amp;g_TraceHandle, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ERROR_SUCCESS != status)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[%s] ProcessTrace() failed with %lu\n"</span>, __FUNCTION__, status);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[%s] ProcessTrace() return\n"</span>, __FUNCTION__);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ERROR_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">MyStopTrace</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ULONG status = ERROR_SUCCESS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (g_TraceHandle &amp;&amp; INVALID_PROCESSTRACE_HANDLE != g_TraceHandle)</span><br><span class="line">    &#123;</span><br><span class="line">        status = CloseTrace(g_TraceHandle);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ERROR_SUCCESS != status)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[%s] CloseTrace() failed with %lu\n"</span>, __FUNCTION__, status);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (g_SessionHandle)</span><br><span class="line">    &#123;</span><br><span class="line">        status = EnableTraceEx2(g_SessionHandle, &amp;SystemTraceControlGuid, EVENT_CONTROL_CODE_DISABLE_PROVIDER, TRACE_LEVEL_VERBOSE, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ERROR_SUCCESS != status)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[%s] EnableTraceEx2(disable) failed with %lu\n"</span>, __FUNCTION__, status);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        status = ControlTrace(g_SessionHandle, KERNEL_LOGGER_NAME, g_pSessionProperties, EVENT_TRACE_CONTROL_STOP);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ERROR_SUCCESS != status)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[%s] ControlTrace(stop) failed with %lu\n"</span>, __FUNCTION__, status);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (g_pSessionProperties)</span><br><span class="line">        <span class="built_in">free</span>(g_pSessionProperties);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hThread;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!MyInitTrace())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hThread = CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)MyStratTrace, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!hThread)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[%s] CreateThread() failed with %lu\n"</span>, __FUNCTION__, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Press any key to end trace session\n"</span>);</span><br><span class="line">    _getch();</span><br><span class="line"></span><br><span class="line">    MyStopTrace();</span><br><span class="line">    WaitForSingleObject(hThread, INFINITE);</span><br><span class="line">    CloseHandle(hThread);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/12/28/mimikatz源码分析/" rel="next" title="mimikatz源码分析">
                <i class="fa fa-chevron-left"></i> mimikatz源码分析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">sup817ch</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">18</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ETW概述"><span class="nav-number">1.</span> <span class="nav-text">ETW概述</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Controllers"><span class="nav-number">1.1.</span> <span class="nav-text">Controllers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Providers"><span class="nav-number">1.2.</span> <span class="nav-text">Providers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Consumers"><span class="nav-number">1.3.</span> <span class="nav-text">Consumers</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#logman使用"><span class="nav-number">2.</span> <span class="nav-text">logman使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#列出所有正在运行的跟踪会话"><span class="nav-number">2.1.</span> <span class="nav-text">列出所有正在运行的跟踪会话</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#列出所有订阅跟踪会话的提供者"><span class="nav-number">2.2.</span> <span class="nav-text">列出所有订阅跟踪会话的提供者</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#列出所有已注册的ETW提供者"><span class="nav-number">2.3.</span> <span class="nav-text">列出所有已注册的ETW提供者</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#单独查看提供者"><span class="nav-number">2.4.</span> <span class="nav-text">单独查看提供者</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查看进程接收的提供者"><span class="nav-number">2.5.</span> <span class="nav-text">查看进程接收的提供者</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#代码示例"><span class="nav-number">3.</span> <span class="nav-text">代码示例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#NT-Kernel-Logger的开启与事件获取（TdhFormatProperty）"><span class="nav-number">3.1.</span> <span class="nav-text">NT Kernel Logger的开启与事件获取（TdhFormatProperty）</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sup817ch</span>

  

  
</div>


  



  <div class="powered-by">由 <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a> 强力驱动 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" rel="external nofollow" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



	





  





  










  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  

  

  

  

  

  

</body>
</html>
